version: 2

references:
  ## Workspaces
  workspace: &workspace
    ~/src

  ## Docker image configurations
  android_config: &android_config
    working_directory: *workspace
    docker:
      - image: circleci/android:api-27
    environment:
      TERM: dumb
      _JAVA_OPTIONS: "-Xmx2048m -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap"
      GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m"'
    - restore_cache:
      key: circlev2-{{ checksum "Gemfile.lock" }}
    - run: bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
    # Store bundle cache
    - save_cache:
      key: circlev2-{{ checksum "Gemfile.lock" }}
      paths:
         - vendor/bundle


jobs:
  deploy_qs:
    <<: *android_config
    steps:
      - checkout
  merge_after_pull_request:
    <<: *android_config
    steps:
      - checkout

workflows:
  version: 2
  workflow:
    jobs:
      - deploy_qs:
          # requires:
            # - approval_for_build_after_pull_request
          filters:
            branches:
              only:
                - test
      # - approval_for_build_after_pull_request:
      #     type: approval
      #     filters:
      #       branches:
      #         only:
      #           - /features/*
      # - merge_after_pull_request:
      #     requires:
      #         - approval_for_merge_after_pull_request
      #     filters:
      #       branches:
      #         only:
      #           - /features/*
      # - approval_for_merge_after_pull_request:
      #     type: approval
      #     requires:
      #         - deploy_qs
      #     filters:
      #       branches:
      #         only:
      #           - /features/*

          
