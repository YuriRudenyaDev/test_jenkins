references:
  ## Workspaces
  workspace: &workspace
               ~/src

  ## Docker image configurations
  android_config: &android_config
    working_directory: *workspace
    docker:
      - image: circleci/android:example
    environment:
      GRADLE_OPTS: -Xmx3g -Xms3g

  ## Dependencies
  ruby_dependencies2: &ruby_dependencies2
    run:
      name: Bundle update
      command: bundle update --bundler


jobs:

  test:
    <<: *android_config
    steps:
      - checkout
      - restore_cache:
            key: circlev2-{{ checksum "Gemfile.lock" }}
      - run: bundle config set --local path 'vendor/bundle' && bundle check || bundle install --jobs=4 --retry=3
      - *ruby_dependencies2
      - run:
          name: Bundler update
          command: gem install bundler:2.1.2
      # Store bundle cache
      - save_cache:
          key: circlev2-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle



version: 2.1
workflows:
  workflow:
    jobs:
      - test:
          filters:
            branches:
              only:
                - test