references:
  ## Workspaces
  workspace: &workspace
               ~/src

  ## Docker image configurations
  android_config: &android_config
    working_directory: *workspace
    docker:
      - image: circleci/android:example
    environment:
      GRADLE_OPTS: -Xmx3g -Xms3g
      # GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx4608M -XX:+HeapDumpOnOutOfMemoryError"'
     # _JAVA_OPTIONS: "-Xms512m -Xmx4608m"

  gems_key: &gems_key
     circlev2-{{ checksum "Gemfile.lock" }}


  restore_gems_cache: &restore_gems_cache
    restore_cache:
      key: *gems_key

  save_gems_cache: &save_gems_cache
    save_cache:
      key: *gems_key
      paths:
        - vendor/bundle

  ## Dependencies
  ruby_dependencies2: &ruby_dependencies2
    run:
      name: Bundle update
      command: bundle update --bundler


jobs:
  test:
    <<: *android_config
    steps:
      - checkout
      - run: *restore_gems_cache
      - *ruby_dependencies2
      - run:
          name: Bundler update
          command: gem install bundler:2.1.2
      - *save_gems_cache

version: 2.1
workflows:
  workflow:
    jobs:
      - test:
          filters:
            branches:
              only:
                - master